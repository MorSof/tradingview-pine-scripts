//@version=5
strategy("DR Soferian Strategy", overlay=true, default_qty_type=strategy.cash)

// === INPUTS ===
ma50_len = input(50, title="MA 50 Length")
ma150_len = input(150, title="MA 150 Length")
ma200_len = input(200, title="MA 200 Length")
atr_len = input(14, title="ATR Length")
atr_mult = input(1.5, title="ATR Stop Multiplier")
trail_atr_mult = input(2.5, title="Trailing Stop ATR Multiplier (Base)")
vol_mult = input(2.0, title="Volume Breakout Multiplier")
weak_vol_mult = input(1.5, title="Weak Volume Multiplier")
breakout_lookback = input(20, title="Base Breakout Lookback")
close_to_ma_pct = input(5.0, title="Buffer % Near 50MA Before Exiting")
extra_ma_buffer_pct = input(0.5, title="Extra Stop Buffer % Below 50MA")

account_size = input(10000, title="Account Size ($)")
risk_percent = input(1.0, title="Risk per Trade (%)")
min_position_percent = input(75.0, title="Minimum Position % of Account")

// === MOVING AVERAGES ===
ma50 = ta.sma(close, ma50_len)
ma150 = ta.sma(close, ma150_len)
ma200 = ta.sma(close, ma200_len)

// === ATR & VOLUME ===
atr = ta.atr(atr_len)
highest_high = ta.highest(high, breakout_lookback)
avg_vol = ta.sma(volume, 50)

// === TREND CONDITIONS ===
trend_ok = close > ma50 and close > ma150 and close > ma200 and ma50 > ma150 and ma150 > ma200 and ma200 > ma200[20]

// === BREAKOUT & VOLUME ===
breakout = close > highest_high[1]
high_vol = volume > (avg_vol * vol_mult)

// === STOP LOSS ===
stop_price = close - (atr * atr_mult)
stop_dist = math.max(close - stop_price, syminfo.mintick)

// === BACKTEST TIME FILTER ===
in_range = (year(time) >= (year(timenow) - 3))

// === POSITION SIZE CALCULATION ===
risk_dollars = (account_size * (risk_percent / 100))
pos_size_risk = risk_dollars / stop_dist
pos_size_min = (account_size * (min_position_percent / 100)) / close
pos_size = math.max(pos_size_risk, pos_size_min)

// === DYNAMIC TRAILING STOP ===
var float trail = na
if (strategy.position_size > 0)
    high_in_trade = ta.highest(high, bar_index - strategy.opentrades.entry_bar_index(0) + 1)
    gain = (high_in_trade - strategy.opentrades.entry_price(0)) / strategy.opentrades.entry_price(0)
    trail_mult =
         gain > 0.3 ? trail_atr_mult * 2.0 :
         gain > 0.15 ? trail_atr_mult * 1.5 :
         trail_atr_mult
    trail := high_in_trade - (atr * trail_mult)
else
    trail := na

// === ENTRY CONDITION ===
enter = trend_ok and breakout and high_vol and in_range

if (enter)
    strategy.entry("Long", strategy.long, qty=pos_size)

// === R LEVELS ===
var float r1 = na
var float r2 = na
var float r3 = na

if (strategy.position_size > 0)
    entry_price = strategy.opentrades.entry_price(0)
    r1 := entry_price + stop_dist * 1
    r2 := entry_price + stop_dist * 2
    r3 := entry_price + stop_dist * 3
else
    r1 := na
    r2 := na
    r3 := na

// === TRACK R LEVELS HIT ===
var bool r1_hit = false
var bool r2_hit = false
var bool r3_hit = false

if (strategy.position_size > 0)
    if (not r1_hit and high >= r1)
        strategy.close("Long", qty_percent=25, comment="Close long partially")
        r1_hit := true
    if (not r2_hit and high >= r2)
        strategy.close("Long", qty_percent=25, comment="Close long partially")
        r2_hit := true
    if (not r3_hit and high >= r3)
        strategy.close("Long", qty_percent=25, comment="Close long partially")
        r3_hit := true

// === SMART TRAILING STOP (50MA BUFFER) ===
var float smart_stop = na
if (strategy.position_size > 0)
    dist_to_50 = trail - ma50
    buffer = close_to_ma_pct / 100.0 * close
    use_50 = (dist_to_50 <= buffer) and (ma50 > 0)
    stop_at = use_50 ? (ma50 * (1 - extra_ma_buffer_pct / 100.0)) : trail
    smart_stop := stop_at
else
    smart_stop := na

// === TRAILING STOP - EXIT ===
if (strategy.position_size > 0)
    stop_hit = (low <= smart_stop)
    if (stop_hit)
        strategy.close("Long", comment="Close long fully")
        strategy.cancel("Trail")

// === RESET ON CLOSE ===
if (strategy.position_size == 0)
    r1_hit := false
    r2_hit := false
    r3_hit := false

// === WEAK SIGNAL ===
weak = trend_ok and breakout and (volume > (avg_vol * weak_vol_mult)) and in_range and not enter
plotshape(weak, style=shape.diamond, location=location.abovebar, size=size.small, 
     color=color.new(color.orange, 20), title="Weak", text="Watch")

// === PLOT ENTRY SIGNAL ===
plotshape(enter, style=shape.triangleup, location=location.belowbar, size=size.normal, 
     color=color.new(color.lime, 0), title="Strong", text="Strong")

// === PLOT MOVING AVERAGES ===
plot(ma50, color=color.new(color.green, 0), title="MA50", linewidth=2)
plot(ma150, color=color.new(color.blue, 0), title="MA150", linewidth=2)
plot(ma200, color=color.new(color.red, 0), title="MA200", linewidth=2)

// === PLOT SMART STOP ===
plot(smart_stop, color=color.purple, title="TrailStop", style=plot.style_linebr, linewidth=2)

// === PLOT R LEVELS ===
plot(r1, title="R1", color=color.new(color.gray, 0), style=plot.style_linebr, linewidth=1)
plot(r2, title="R2", color=color.new(color.gray, 0), style=plot.style_linebr, linewidth=1)
plot(r3, title="R3", color=color.new(color.gray, 0), style=plot.style_linebr, linewidth=1)
