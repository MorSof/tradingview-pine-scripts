//@version=5
strategy("5m Opening Range Strategy (1R:2R) + Visuals", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// â”€â”€â”€ INPUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
r_dollars = input.float(30, "Risk per trade ($)")
r_multiple = input.int(1, "Reward Multiple", minval=1)
high_proximity_buffer = input.float(0.005, "High Proximity Threshold (e.g., 0.005 = 0.5%)")

// â”€â”€â”€ MA + ATR SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ma20 = ta.sma(close, 20)
ma200 = ta.sma(close, 200)
daily_atr = request.security(syminfo.tickerid, "D", ta.atr(14))
prev_close = request.security(syminfo.tickerid, "D", close)
yest_low = request.security(syminfo.tickerid, "D", low)
yest_high = request.security(syminfo.tickerid, "D", high)

// â”€â”€â”€ TODAY'S LOW BASED ON 5M CHART â”€
is_new_day = ta.change(time("D")) != 0
var float today_low_5m = na
today_low_5m := is_new_day ? low : math.min(today_low_5m, low)

// â”€â”€â”€ PRICE RANGE LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
price_range_base = math.min(prev_close, today_low_5m)
max_price_up = price_range_base + daily_atr

// â”€â”€â”€ TIME FILTER: FIRST 15 MINUTES â”€
candle_number = (hour == 9 and minute >= 30 and minute < 35) ? 1 : (hour == 9 and minute >= 35 and minute < 40) ? 2 : (hour == 9 and minute >= 40 and minute < 45) ? 3 : na

// â”€â”€â”€ TRACK HIGHS FOR CANDLES 1 & 2 â”€â”€
var float high_c1 = na
var float high_c2 = na
high_c1 := is_new_day or candle_number == 1 ? high : high_c1
high_c2 := is_new_day or candle_number == 2 ? high : high_c2

// â”€â”€â”€ ENTRY CONDITION SINGLE LINE â”€â”€â”€â”€
near_yest_high_and_not_breaking = (yest_high - close) / close <= high_proximity_buffer and close <= yest_high

enter_long = (close > open and (high - close) <= (high - low) * 0.25) and
             (close > ma20 and ma20 > ma200) and
             (close > prev_close) and
             ((candle_number == 1) or
              (candle_number == 2 and close > high_c1) or
              (candle_number == 3 and close > high_c1 and close > high_c2)) and
             (hour == 9 and minute >= 30 and minute < 45) and
             (close - price_range_base > 0) and
             ((close - price_range_base + r_multiple * (close - price_range_base)) <= daily_atr) and
             ((close - price_range_base) <= r_dollars) and
             not near_yest_high_and_not_breaking

// â”€â”€â”€ STOP LOSS WITH BUFFER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
use_yest_low = (close - yest_low) / close <= 0.01
stop_buffer = daily_atr * 0.1  // 10% of ATR as buffer
raw_stop = use_yest_low ? yest_low : math.min(prev_close, today_low_5m)
initial_stop_loss = raw_stop - stop_buffer

// â”€â”€â”€ RISK & REWARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
risk_per_share = close - initial_stop_loss
position_size = r_dollars / risk_per_share
position_size_rounded = math.floor(position_size)
initial_take_profit = math.min(close + r_multiple * risk_per_share, max_price_up)

// â”€â”€â”€ POSITION MANAGEMENT VARIABLES â”€â”€â”€
var int entry_bar_index = na
var int last_adjustment_bar = na
var float dynamic_tp = na
var float dynamic_sl = na
var bool in_trade = false

if enter_long
    strategy.entry("Long", strategy.long, qty=position_size_rounded)
    entry_bar_index := bar_index
    last_adjustment_bar := na
    dynamic_tp := initial_take_profit
    dynamic_sl := initial_stop_loss
    in_trade := true

if strategy.position_size == 0
    entry_bar_index := na
    last_adjustment_bar := na
    dynamic_tp := na
    dynamic_sl := na
    in_trade := false

// â”€â”€â”€ TP/SL UPDATE EVERY HOUR AFTER 2 HOURS â”€â”€â”€
bars_since_entry = bar_index - entry_bar_index
lookback_bars = 12  // last 1 hour of 5m candles

should_adjust = in_trade and not na(entry_bar_index) and bars_since_entry >= 24 and (na(last_adjustment_bar) or bar_index - last_adjustment_bar >= 12)

last_hour_high = ta.highest(high, lookback_bars)
last_hour_low = ta.lowest(low, lookback_bars)

if should_adjust
    dynamic_tp := last_hour_high
    dynamic_sl := last_hour_low
    last_adjustment_bar := bar_index

// â”€â”€â”€ SINGLE DYNAMIC EXIT â”€â”€â”€
if in_trade
    strategy.exit("Dynamic TP/SL", from_entry="Long", limit=dynamic_tp, stop=dynamic_sl)

// â”€â”€â”€ PLOTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
plot(ma20, color=color.orange, title="MA 20")
plot(ma200, color=color.blue, title="MA 200")
plotshape(enter_long, title="Entry", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small)
plot(prev_close, "Previous Close", color=color.white, linewidth=1, style=plot.style_line)
plot(yest_low, "Yesterday Low", color=color.red, linewidth=1, style=plot.style_line)
plot(yest_high, "Yesterday High", color=color.green, linewidth=1, style=plot.style_line)
plot(max_price_up, "Expected Max Up (ATR)", color=color.aqua, linewidth=1, style=plot.style_line)
plot(in_trade ? dynamic_tp : na, title="Adjusted TP", color=color.lime, linewidth=2, style=plot.style_linebr)
plot(in_trade ? dynamic_sl : na, title="Adjusted SL", color=color.red, linewidth=2, style=plot.style_linebr)

// â”€â”€â”€ DEBUG LABELS FOR FIRST 3 CANDLES â”€â”€â”€â”€â”€
if candle_number == 1 or candle_number == 2 or candle_number == 3
    candle_cond = candle_number == 1 or
                  (candle_number == 2 and close > high_c1) or
                  (candle_number == 3 and close > high_c1 and close > high_c2)
    
    label_text = "Candle " + str.tostring(candle_number) + "\nopen<close: " + (close > open ? "âœ…" : "âŒ") + "\ntail ok: " + ((high - close) <= (high - low) * 0.25 ? "âœ…" : "âŒ") + "\nMA order: " + ((close > ma20 and ma20 > ma200) ? "âœ…" : "âŒ") + "\n>prev: " + (close > prev_close ? "âœ…" : "âŒ") + "\ncandle ok: " + ((candle_number == 1) or (candle_number == 2 and close > high_c1) or (candle_number == 3 and close > high_c1 and close > high_c2) ? "âœ…" : "âŒ") + "\nrange ok: " + ((close - price_range_base > 0) ? "âœ…" : "âŒ") + "\nin ATR: " + (((close - price_range_base + r_multiple * (close - price_range_base)) <= daily_atr) ? "âœ…" : "âŒ") + "\nâ‰¤$" + str.tostring(r_dollars) + ": " + ((close - price_range_base <= r_dollars) ? "âœ…" : "âŒ") + "\nnot near yHigh: " + (not near_yest_high_and_not_breaking ? "âœ…" : "âŒ") + "\nğŸ“¦ Shares: " + str.tostring(position_size_rounded) + "\nğŸ¯ TP: " + str.tostring(initial_take_profit, "#.##") + "\nğŸ§¯ SL: " + str.tostring(initial_stop_loss, "#.##")

    label.new(bar_index, low, label_text, yloc=yloc.belowbar, style=label.style_label_down, color=color.new(color.gray, 0), textcolor=color.white, size=size.small)
